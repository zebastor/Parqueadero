@{
    ViewData["Title"] = "Mapa de Parqueaderos";
    // Obtenemos la clave de API que pasamos desde el controlador
    var mapsApiKey = ViewBag.MapsApiKey;
}

<style>
    #map {
        height: 600px;
        width: 100%;
    }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 text-gray-800">Ubicación de Parqueaderos</h1>
        <a asp-controller="Dashboard" asp-action="Cliente" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Volver al Dashboard
        </a>
    </div>

    <div class="card shadow mb-4">
        <div class="card-body">
            <div id="map"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Función que Google Maps llamará cuando la API esté lista
        function initMap() {
            // 1. Coordenadas iniciales (centrado en Colombia)
            const centroColombia = { lat: 4.5709, lng: -74.2973 };

            // 2. Crear el mapa
            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 6,
                center: centroColombia,
            });

            // 3. Obtener los parqueaderos desde NUESTRA API
            fetch('/api/Parqueaderos')
                .then(response => response.json())
                .then(parqueaderos => {

                    parqueaderos.forEach(parqueadero => {

                        // 4. Crear un pin (Marker) por cada parqueadero
                        const marker = new google.maps.Marker({
                            position: {
                                lat: parseFloat(parqueadero.latitud),
                                lng: parseFloat(parqueadero.longitud)
                            },
                            map: map,
                            title: parqueadero.nombre,
                        });

                        // 5. (Opcional) Añadir una ventana de info al hacer clic
                        const infoWindow = new google.maps.InfoWindow({
                            content: `<h5>${parqueadero.nombre}</h5><p>${parqueadero.direccion}</p>`
                        });

                        marker.addListener("click", () => {
                            infoWindow.open(map, marker);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error al cargar parqueaderos:', error);
                    Swal.fire('Error', 'No se pudieron cargar los parqueaderos en el mapa.', 'error');
                });
        }
    </script>

    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=@mapsApiKey&callback=initMap">
    </script>
}