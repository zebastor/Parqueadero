@{
    ViewData["Title"] = "Crear Reserva";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 text-gray-800">Crear Reserva</h1>
        <a asp-action="Index" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Volver
        </a>
    </div>

    <div class="card shadow mb-4">
        <div class="card-body">
            <form id="formCrearReserva">
                <div class="row">
                    <!-- Selección de Parqueadero -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="parqueaderoId">Parqueadero</label>
                            <select class="form-control" id="parqueaderoId" required>
                                <option value="">Seleccione un parqueadero</option>
                            </select>
                            <div class="invalid-feedback">El parqueadero es requerido</div>
                        </div>
                    </div>

                    <!-- Selección de Piso -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="pisoId">Piso</label>
                            <select class="form-control" id="pisoId" required>
                                <option value="">Seleccione un piso</option>
                            </select>
                            <div class="invalid-feedback">El piso es requerido</div>
                        </div>
                    </div>

                    <!-- Selección de Vehículo primero -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="vehiculoId">Vehículo (Placa)</label>
                            <select class="form-control" id="vehiculoId" required>
                                <option value="">Seleccione un vehículo</option>
                            </select>
                            <div class="invalid-feedback">El vehículo es requerido</div>
                        </div>
                    </div>

                    <!-- Usuario asignado (solo lectura) -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="usuarioId">Cliente asignado</label>
                            <input type="text" class="form-control" id="usuarioId" readonly>
                        </div>
                    </div>

                    <!-- Resto del formulario sigue igual -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="placa">Reconocer Placa</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="placa" readonly>
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" id="btnAbrirCamara">
                                        <i class="fas fa-camera"></i> Abrir Cámara
                                    </button>
                                    <button class="btn btn-outline-secondary" type="button" id="btnCapturarPlaca" style="display: none;">
                                        <i class="fas fa-capture"></i> Capturar
                                    </button>
                                </div>
                            </div>
                            <div id="estadoPlaca" class="mt-2 small" style="display: none;">
                                <span id="estadoTexto"></span>
                            </div>
                            <div class="mt-3">
                                <video id="video" width="320" height="240" autoplay playsinline style="display: none;"></video>
                                <canvas id="canvas" style="display: none;"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="zonaId">Zona</label>
                            <select class="form-control" id="zonaId" required>
                                <option value="">Seleccione una zona</option>
                            </select>
                            <div class="invalid-feedback">La zona es requerida</div>
                        </div>
                    </div>

                    <div class="col-12 mt-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Guardar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let stream;
        let reconocimientoInterval;
        let ultimaPlacaDetectada = null;
        let imagenBase64Capturada = null;

        // ===============================
        // Función para iniciar reconocimiento automático
        // ===============================
        function iniciarReconocimientoAutomatico() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const estadoDiv = document.getElementById('estadoPlaca');
            const estadoTexto = document.getElementById('estadoTexto');

            estadoDiv.style.display = 'block';
            estadoTexto.textContent = 'Esperando detección...';
            estadoTexto.className = 'text-info';

            reconocimientoInterval = setInterval(() => {
                if (!stream) return;

                const ctx = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                const imageData = canvas.toDataURL('image/jpeg', 1);

                estadoTexto.textContent = 'Procesando imagen...';
                estadoTexto.className = 'text-info';

                fetch('/api/Reservas/ProcesarImagen', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ imageData: imageData })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.placa) {
                        let placa = data.placa.toUpperCase().replace(/\s+/g, '').replace('-', '');

                        if (placa !== ultimaPlacaDetectada) {
                            ultimaPlacaDetectada = placa;

                            // Asignar placa al input y buscar datos
                            $('#vehiculoId').val(placa); // Nota: Si el select no tiene la opción, esto podría fallar visualmente si no se agrega dinámicamente, pero para inputs de texto funciona bien. Si es select, lo ideal es buscar si existe.
                            buscarVehiculoYCliente(placa);

                            // Guardar imagen capturada
                            imagenBase64Capturada = imageData;

                            // Detener reconocimiento
                            clearInterval(reconocimientoInterval);
                            estadoTexto.textContent = `Placa detectada: ${placa}`;
                            estadoTexto.className = 'text-success';
                        }
                    } else {
                        estadoTexto.textContent = data.message || 'No se pudo reconocer la placa.';
                        estadoTexto.className = 'text-warning';
                    }
                })
                .catch(err => {
                    console.error('Error al procesar la imagen:', err);
                    estadoTexto.textContent = 'Error al procesar la imagen.';
                    estadoTexto.className = 'text-danger';
                });
            }, 1000);
        }

        // ===============================
        // Buscar vehículo y cliente automáticamente
        // ===============================
        function buscarVehiculoYCliente(placa) {
            $.get(`/api/Vehiculos/placa/${placa}`)
                .done(function(vehiculo) {
                    if (vehiculo) {
                        // Llenar datos del usuario
                        $('#usuarioId').val(vehiculo.usuarioNombre);
                        $('#usuarioId').data('usuarioId', vehiculo.usuarioId); // Guardamos el ID real en data attribute

                        // Intentar cargar zonas si ya hay piso seleccionado
                        const pisoId = $('#pisoId').val();
                        if (pisoId) {
                            cargarZonas(placa, pisoId);
                        }
                    } else {
                        $('#usuarioId').val('');
                        $('#usuarioId').data('usuarioId', null);
                        Swal.fire({ icon: 'warning', title: 'Vehículo no encontrado', text: 'No se encontró un vehículo registrado con esta placa' });
                    }
                })
                .fail(function() {
                    $('#usuarioId').val('');
                    $('#usuarioId').data('usuarioId', null);
                });
        }

        // ===============================
        // Función auxiliar para cargar zonas
        // ===============================
        function cargarZonas(placa, pisoId) {
            const selectZona = $('#zonaId');
            selectZona.empty().append('<option value="">Cargando zonas...</option>');

            $.get(`/api/Zonas/TipoVehiculo/${placa}/Piso/${pisoId}`)
                .done(zonas => {
                    selectZona.empty().append('<option value="">Seleccione una zona</option>');
                    if (zonas.length === 0) {
                        selectZona.append('<option value="" disabled>No hay zonas disponibles para este vehículo en este piso</option>');
                    }
                    zonas.forEach(z => selectZona.append(`<option value="${z.id}">${z.nombre} (${z.codigo || 'Sin código'})</option>`));
                })
                .fail(() => {
                    selectZona.empty().append('<option value="">Error al cargar zonas</option>');
                });
        }

        // ===============================
        // Botón abrir/cerrar cámara
        // ===============================
        $("#btnAbrirCamara").on("click", function() {
            const video = document.getElementById('video');
            if (!stream) {
                navigator.mediaDevices.enumerateDevices()
                    .then(devices => {
                        const backCamera = devices.find(d =>
                            d.kind === 'videoinput' &&
                            (d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('rear') || d.label.toLowerCase().includes('trás'))
                        );
                        const constraints = { video: {} };
                        if (backCamera) constraints.video.deviceId = { exact: backCamera.deviceId };
                        else constraints.video.facingMode = 'environment';
                        return navigator.mediaDevices.getUserMedia(constraints);
                    })
                    .then(s => {
                        stream = s;
                        video.srcObject = stream;
                        video.play();
                        video.style.display = 'block';
                        $('#btnAbrirCamara').html('<i class="fas fa-stop"></i> Detener Cámara');
                        iniciarReconocimientoAutomatico();
                    })
                    .catch(error => {
                        console.error('Error al acceder a la cámara:', error);
                        Swal.fire({  title: 'Error', text: 'No se pudo acceder a la cámara: ' + error.message });
                    });
            } else {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                video.srcObject = null;
                video.style.display = 'none';
                clearInterval(reconocimientoInterval);
                ultimaPlacaDetectada = null;
                $('#btnAbrirCamara').html('<i class="fas fa-camera"></i> Abrir Cámara');
                document.getElementById('estadoPlaca').style.display = 'none';
            }
        });

        // ===============================
        // Inicialización y Eventos del Formulario
        // ===============================
        $(document).ready(function() {

            // 1. Cargar Vehículos (para el select inicial)
            $.get('/api/Vehiculos').done(function(vehiculos) {
                const select = $('#vehiculoId');
                select.empty().append('<option value="">Seleccione un vehículo</option>');
                vehiculos.forEach(v => select.append(`<option value="${v.placa}">${v.placa}</option>`));
            });

            // 2. Cargar Parqueaderos
            $.get('/api/Parqueaderos').done(function(parqueaderos) {
                const select = $('#parqueaderoId');
                select.empty().append('<option value="">Seleccione un parqueadero</option>');
                if(parqueaderos.length === 0) {
                    select.append('<option value="" disabled>No hay parqueaderos disponibles</option>');
                }
                parqueaderos.forEach(p => {
                    select.append(`<option value="${p.id}">${p.nombre}</option>`);
                });
            });

            // 3. Evento: Cambio de Parqueadero -> Cargar Pisos
            $('#parqueaderoId').on('change', function() {
                const parqueaderoId = $(this).val();
                const selectPiso = $('#pisoId');

                // Limpiar dependencias
                selectPiso.empty().append('<option value="">Cargando...</option>');
                $('#zonaId').empty().append('<option value="">Seleccione una zona</option>');

                if (!parqueaderoId) {
                    selectPiso.empty().append('<option value="">Seleccione un piso</option>');
                    return;
                }

                $.get(`/api/Pisos/${parqueaderoId}`)
                    .done(pisos => {
                        selectPiso.empty().append('<option value="">Seleccione un piso</option>');
                        if (pisos.length === 0) {
                            selectPiso.append('<option value="" disabled>No hay pisos configurados</option>');
                        }
                        pisos.forEach(p => {
                            selectPiso.append(`<option value="${p.id}">Piso ${p.numero}</option>`);
                        });
                    })
                    .fail(error => {
                        console.error(error);
                        selectPiso.empty().append('<option value="">Error al cargar pisos</option>');
                    });
            });

            // 4. Evento: Cambio de Piso -> Cargar Zonas (si hay vehículo)
            $('#pisoId').on('change', function() {
                const pisoId = $(this).val();
                const placa = $('#vehiculoId').val();
                if (pisoId && placa) {
                    cargarZonas(placa, pisoId);
                }
            });

            // 5. Evento: Cambio de Vehículo -> Buscar Cliente y Cargar Zonas (si hay piso)
            $('#vehiculoId').on('change', function() {
                const placa = $(this).val();
                if (!placa) {
                    $('#usuarioId').val('');
                    $('#usuarioId').data('usuarioId', null);
                    return;
                }
                buscarVehiculoYCliente(placa);
            });

            // 6. Submit del Formulario
            $('#formCrearReserva').on('submit', function(e) {
                e.preventDefault();

                if (this.checkValidity() === false) {
                    e.stopPropagation();
                    $(this).addClass('was-validated');
                    return;
                }

                const usuarioId = $('#usuarioId').data('usuarioId');
                const vehiculoPlaca = $('#vehiculoId').val();
                const zonaId = $('#zonaId').val(); // No usamos parseInt directo por si es nulo

                // Validaciones manuales extra
                if (!usuarioId) {
                    Swal.fire({  title: 'Datos incompletos', text: 'No se pudo determinar el cliente del vehículo.' });
                    return;
                }
                if (!zonaId) {
                    Swal.fire({title: 'Datos incompletos', text: 'Debe seleccionar una zona.' });
                    return;
                }

                // Obtener ID del vehículo antes de enviar
                $.get(`/api/Vehiculos/placa/${vehiculoPlaca}`)
                    .done(function(vehiculo) {
                        if (!vehiculo) {
                            Swal.fire({  title: 'Error', text: 'Vehículo no encontrado en base de datos.' });
                            return;
                        }

                        const reservaData = {
                            vehiculoId: vehiculo.id,
                            usuarioId: parseInt(usuarioId),
                            zonaId: parseInt(zonaId),
                            horaEntrada: new Date().toISOString(),
                            imagenPlaca: imagenBase64Capturada ? imagenBase64Capturada.split(',')[1] : null
                        };

                        $.ajax({
                            url: '/api/Reservas',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(reservaData),
                            success: function() {
                                Swal.fire({
                                   
                                    title: '¡Éxito!',
                                    text: 'La reserva ha sido creada correctamente',
                                    showConfirmButton: false,
                                    timer: 1500
                                }).then(() => window.location.href = '/Reserva/Index');
                            },
                            error: function(xhr) {
                                let errorMessage = 'Ocurrió un error al crear la reserva';
                                if (xhr.responseJSON && xhr.responseJSON.mensaje) errorMessage = xhr.responseJSON.mensaje;
                                Swal.fire({  title: 'Error', text: errorMessage });
                            }
                        });
                    })
                    .fail(function() {
                        Swal.fire({  title: 'Error', text: 'Error al validar el vehículo.' });
                    });
            });
        });
    </script>
}
