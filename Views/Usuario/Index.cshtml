@{
    ViewData["Title"] = "Usuarios";
    var empresaNombre = User.FindFirst("EmpresaNombre")?.Value;
    var esSuperUsuario = User.IsInRole("SuperUsuario");
    var esAdministrador = User.IsInRole("Administrador");
}

<div class="container-fluid">
    
    <div class="d-flex justify-content-between align-items-center mb-5 border-bottom pb-3">
        <h1 class="h2 text-dark">
            <i class="fas fa-users text-primary me-2"></i> Gestión de Usuarios
            @if (esAdministrador || User.IsInRole("Trabajador"))
            {
                <span id="empresaTitulo" class="text-secondary small"></span>
            }
        </h1>

        <div>
            @if (esSuperUsuario || esAdministrador)
            {
                <a asp-action="Crear" class="btn btn-info btn-lg me-2">
                    <i class="fas fa-user-plus"></i> Nuevo Empleado
                </a>
            }
            <a asp-action="CrearCliente" class="btn btn-success btn-lg me-2">
                <i class="fas fa-user-tag"></i> Nuevo Cliente
            </a>
            <a asp-controller="Dashboard" asp-action="Index" class="btn btn-outline-secondary btn-lg">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </div>
    
    <h2 class="h4 text-dark mb-3"><i class="fas fa-briefcase me-2"></i> Personal Administrativo y Trabajadores</h2>
    <div class="card shadow mb-5 border-left-info">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="empleadosTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Correo</th>
                            <th>Rol</th>
                            @if (esSuperUsuario){
                                <th>Empresa</th>
                            }
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <h2 class="h4 text-dark mb-3"><i class="fas fa-user-friends me-2"></i> Clientes</h2>
    <div class="card shadow mb-4 border-left-success">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="clientesTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Correo</th>
                            <th>Rol</th>
                            @if (esSuperUsuario){
                                <th>Empresa</th>
                            }
                            <th>Planes asociados</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="asignarPlanModal" tabindex="-1" aria-labelledby="asignarPlanModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="asignarPlanModalLabel">Asignar Plan Especial</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="empresaIdSelect" class="form-label">Seleccionar Empresa</label>
                    <select class="form-select" id="empresaIdSelect">
                        <option value="">Seleccione una empresa</option>
                    </select>
                </div>
                
                <div id="cargandoPlanes" class="text-center mb-3" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
                
                <div id="listaPlanes">
                    <p>Seleccione un plan especial:</p>
                    <select class="form-select" id="planEspecialId">
                        <option value="">Seleccione un plan</option>
                    </select>
                </div>
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnAsignarPlan">Asignar Plan</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let usuarioIdSeleccionado = null;
    const ROLES = { 0: 'SuperUsuario', 1: 'Administrador', 2: 'Trabajador', 3: 'Cliente' };
    const esSuperUsuario = @Json.Serialize(esSuperUsuario);
    const esAdministrador = @Json.Serialize(esAdministrador);
    const esTrabajador = @Json.Serialize(User.IsInRole("Trabajador"));
    const usuarioAutenticadoId = parseInt('@User.FindFirst("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier")?.Value ?? "0"') || 0;

    // --- LÓGICA DEL MODAL DE ASIGNACIÓN DE PLANES (Se mantiene igual, solo se mueve) ---
    document.getElementById('asignarPlanModal').addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        usuarioIdSeleccionado = button.getAttribute('data-usuario-id');

        document.getElementById('cargandoPlanes').style.display = 'block';
        document.getElementById('listaPlanes').style.display = 'none';

        const selectEmpresa = document.getElementById('empresaIdSelect');

        // Cargar empresas según rol
        if (esSuperUsuario) {
            fetch('/api/Empresas')
                .then(r => r.json())
                .then(empresas => {
                    selectEmpresa.innerHTML = '<option value="">Seleccione una empresa</option>';
                    empresas.forEach(e => selectEmpresa.innerHTML += `<option value="${e.id}">${e.nombre}</option>`);
                })
                .catch(() => alert('Error al cargar empresas'));
        } else {
            // Administrador / Trabajador -> 1 sola empresa
            fetch('/api/Empresas/MiEmpresa')
                .then(r => r.json())
                .then(empresa => {
                    selectEmpresa.innerHTML = `<option value="${empresa.id}" selected>${empresa.nombre}</option>`;
                    selectEmpresa.disabled = true;
                })
                .catch(() => alert('No se pudo obtener la empresa del usuario.'));
        }

        // Cargar planes
        fetch('/api/PlanesEspeciales')
            .then(r => r.json())
            .then(planes => {
                const select = document.getElementById('planEspecialId');
                select.innerHTML = '<option value="">Seleccione un plan</option>';
                planes.forEach(p => select.innerHTML += `<option value="${p.id}">${p.nombre} - $${p.costo}</option>`);

                document.getElementById('cargandoPlanes').style.display = 'none';
                document.getElementById('listaPlanes').style.display = 'block';
            })
            .catch(() => alert('Error al cargar planes especiales'));
    });

    // Asignar plan
    document.getElementById('btnAsignarPlan').addEventListener('click', function() {
        const planId = document.getElementById('planEspecialId').value;
        const empresaId = document.getElementById('empresaIdSelect').value;

        if (!planId) return alert('Por favor seleccione un plan especial');
        if (!empresaId) return alert('Por favor seleccione una empresa');

        fetch(`/api/Usuarios/${usuarioIdSeleccionado}/Empresa/${empresaId}/PlanEspecial/${planId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => {
            if (!response.ok) throw new Error();
            Swal.fire({ title: 'Éxito', text: 'Plan asignado correctamente', icon: 'success' });
            $('#asignarPlanModal').modal('hide');
            // Recargar la tabla de clientes
            $('#clientesTable').DataTable().ajax.reload(); 
        })
        .catch(() => alert('Error al asignar el plan especial'));
    });

    // --- FUNCIONES DE RENDERING ---
    function renderAcciones(data, type, row) {
        let botones = `<div class="btn-group btn-group-sm" role="group">`;
        const puedeEditar = (esTrabajador && row.rol === 3) || (esAdministrador && row.rol !== 0) || (esSuperUsuario && !(row.rol === 0 && data != usuarioAutenticadoId));
        
        if (puedeEditar) {
            botones += `<a href="/Usuario/Editar/${data}" class="btn btn-info" title="Editar"><i class="fas fa-edit"></i></a>`;
            botones += `<a href="/Usuario/Eliminar/${data}" class="btn btn-danger" title="Eliminar"><i class="fas fa-trash"></i></a>`;
        }

        // Solo el botón de Planes (para Clientes)
        if (row.rol === 3 && (esSuperUsuario || esAdministrador)) {
            botones += `
                <button type="button" class="btn btn-success ms-1"
                        data-bs-toggle="modal" data-bs-target="#asignarPlanModal"
                        data-usuario-id="${data}" title="Asignar Plan">
                    <i class="fas fa-tags"></i>
                </button>`;
        }

        botones += `</div>`;
        return botones;
    }
    
    // Función para el DataTables para filtrar y obtener los datos
    function filterDataByRole(data) {
        // En DataTables, data es el array completo de la respuesta de la API
        return data.filter(item => item.rol !== 3); // Empleados: roles 0, 1, 2
    }
    function filterDataByClientRole(data) {
        return data.filter(item => item.rol === 3); // Clientes: solo rol 3
    }
    

    $(document).ready(function () {
        // Título de la empresa (si aplica)
        var empresaNombre = '@User.FindFirst("EmpresaNombre")?.Value';
        if (empresaNombre) {
            $('#empresaTitulo').text(' de la empresa: ' + empresaNombre);
        }

        // --- Columnas Comunes (para Empleados y Clientes) ---
        var baseColumns = [
            { data: 'nombre' },
            { data: 'correo' },
            {
                data: 'rol',
                render: function (data) { return ROLES[data] || 'Desconocido'; }
            }
        ];

        // Añadir columna Empresa solo si es SuperUsuario
        if (esSuperUsuario) {
            baseColumns.push({ data: 'empresa.nombre' });
        }

        // --- Configuración de la Tabla de EMPLEADOS (roles 0, 1, 2) ---
        var empleadosColumns = [...baseColumns];
        empleadosColumns.push({
            data: 'id',
            className: 'text-center',
            orderable: false,
            render: renderAcciones
        });

        $('#empleadosTable').DataTable({
            ajax: { 
                url: '/api/Usuarios', 
                dataSrc: filterDataByRole // Filtra para mostrar solo roles 0, 1, 2
            },
            columns: empleadosColumns,
            language: { url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json' }
        });


        // --- Configuración de la Tabla de CLIENTES (solo rol 3) ---
        var clientesColumns = [...baseColumns];
        
        // Columna Planes asociados (SOLO para clientes)
        clientesColumns.push({
            data: null,
            orderable: false,
            render: function (data, type, row) {
                if (row.usuarioEmpresas?.length > 0) {
                    return row.usuarioEmpresas.map(ue =>
                        `<span class="badge bg-success me-1">${ue.empresa?.nombre ?? 'Empresa N/A'}</span> <span class="badge bg-primary">${ue.planEspecial?.nombre ?? 'Sin plan'}</span>`
                    ).join('<br>');
                }
                return '<span class="text-muted">No asignado</span>';
            }
        });

        // Columna Acciones para Clientes
        clientesColumns.push({
            data: 'id',
            className: 'text-center',
            orderable: false,
            render: renderAcciones
        });

        $('#clientesTable').DataTable({
            ajax: { 
                url: '/api/Usuarios', 
                dataSrc: filterDataByClientRole // Filtra para mostrar solo rol 3
            },
            columns: clientesColumns,
            language: { url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json' }
        });
    });

</script>
}